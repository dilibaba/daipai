<!DOCTYPE html>
<html lang="zh-CN">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DaiPæ™ºèƒ½èŠå¤©å®¤</title>
        <link rel="stylesheet" href="/static/css/style.css">
        <style>
            /* éŸ³ä¹å¡ç‰‡æ ·å¼ */
            .music-container {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border-radius: 12px;
                padding: 20px;
                margin-top: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .music-container:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            }
            
            .music-info {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .music-image {
                width: 80px;
                height: 80px;
                border-radius: 8px;
                object-fit: cover;
                margin-right: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            
            .music-details {
                flex: 1;
            }
            
            .music-title {
                margin: 0 0 5px 0;
                font-size: 18px;
                font-weight: bold;
                color: #333;
            }
            
            .music-artist {
                margin: 0;
                font-size: 14px;
                color: #666;
            }
            
            .music-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .music-control-btn {
                background-color: #fff;
                border: 1px solid #ddd;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                font-size: 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
            }
            
            .music-control-btn:hover {
                background-color: #2196f3;
                color: white;
                border-color: #2196f3;
                transform: scale(1.1);
            }
            
            .music-progress-container {
                width: 100%;
                height: 6px;
                background-color: #ddd;
                border-radius: 3px;
                overflow: hidden;
                position: relative;
            }
            
            .music-progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #2196f3 0%, #64b5f6 100%);
                transition: width 0.1s ease;
                border-radius: 3px;
            }
            
            @media (max-width: 768px) {
                .music-image {
                    width: 60px;
                    height: 60px;
                }
                
                .music-title {
                    font-size: 16px;
                }
                
                .music-control-btn {
                    width: 36px;
                    height: 36px;
                    font-size: 14px;
                }
            }
        </style>
    </head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <button id="sidebar-toggle" class="sidebar-toggle">â˜°</button>
                <h2>DaiPæ™ºèƒ½èŠå¤©å®¤</h2>
            </div>
            <div class="user-info">
                <span>å½“å‰ç”¨æˆ·ï¼š{{ nickname }}</span>
                <button id="logout-btn" class="logout-btn">é€€å‡º</button>
            </div>
        </div>
        
        <div class="chat-main">
            <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
            <div class="users-sidebar">
                <div class="sidebar-header">
                    <h3>åœ¨çº¿ç”¨æˆ· ( <span id="users-count">0</span> )</h3>
                </div>
                <div class="users-list" id="users-list">
                    <!-- åœ¨çº¿ç”¨æˆ·å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
            
            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages" id="chat-messages">
                <div class="welcome-message">æ¬¢è¿æ¥åˆ°DaiPæ™ºèƒ½èŠå¤©å®¤ï¼</div>
                <div class="help-message">æç¤ºï¼šä½¿ç”¨@ç”µå½± URLå¯ä»¥åˆ†äº«ç”µå½±ï¼Œä½¿ç”¨@å·å°å†œ å¯ä»¥ä¸AIå¯¹è¯ï¼Œä½¿ç”¨@éŸ³ä¹ å¯ä»¥æ’­æ”¾éŸ³ä¹ï¼Œä½¿ç”¨@å¤©æ°” å¯ä»¥æŸ¥è¯¢å¤©æ°”ï¼Œä½¿ç”¨@æ–°é—» å¯ä»¥æŸ¥è¯¢æ–°é—»</div>
            </div>
        </div>
        
        <div class="chat-footer">
            <div class="message-input-container">
                <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯... (ä½¿ç”¨@ç”µå½± URLåˆ†äº«ç”µå½±)" autocomplete="off">
                <button id="send-btn" class="send-btn">å‘é€</button>
            </div>
            <div class="emoji-dropdown">
                <button id="emoji-toggle" class="emoji-toggle">ğŸ˜Š è¡¨æƒ…</button>
                <div id="emoji-panel" class="emoji-panel">
                    <div class="emoji-scroll-container">
                        <!-- emojiè¡¨æƒ…åˆ—è¡¨ -->
                        <span class="emoji" data-emoji="ğŸ˜€">ğŸ˜€</span>
                        <span class="emoji" data-emoji="ğŸ˜‚">ğŸ˜‚</span>
                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                        <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                        <span class="emoji" data-emoji="â¤ï¸">â¤ï¸</span>
                        <span class="emoji" data-emoji="ğŸ‰">ğŸ‰</span>
                        <span class="emoji" data-emoji="ğŸ”¥">ğŸ”¥</span>
                        <span class="emoji" data-emoji="ğŸ˜†">ğŸ˜†</span>
                        <span class="emoji" data-emoji="ğŸ¥°">ğŸ¥°</span>
                        <span class="emoji" data-emoji="ğŸ˜˜">ğŸ˜˜</span>
                        <span class="emoji" data-emoji="ğŸ¤”">ğŸ¤”</span>
                        <span class="emoji" data-emoji="ğŸ˜¢">ğŸ˜¢</span>
                        <span class="emoji" data-emoji="ğŸ˜¡">ğŸ˜¡</span>
                        <span class="emoji" data-emoji="ğŸ¤©">ğŸ¤©</span>
                        <span class="emoji" data-emoji="ğŸ¤—">ğŸ¤—</span>
                        <span class="emoji" data-emoji="ğŸ˜">ğŸ˜</span>
                        <span class="emoji" data-emoji="ğŸ™„">ğŸ™„</span>
                        <span class="emoji" data-emoji="ğŸ˜´">ğŸ˜´</span>
                        <span class="emoji" data-emoji="ğŸ˜±">ğŸ˜±</span>
                        <span class="emoji" data-emoji="ğŸ¥³">ğŸ¥³</span>
                        <span class="emoji" data-emoji="ğŸ¤­">ğŸ¤­</span>
                        <span class="emoji" data-emoji="ğŸ˜·">ğŸ˜·</span>
                        <span class="emoji" data-emoji="ğŸ¤">ğŸ¤</span>
                        <span class="emoji" data-emoji="ğŸ¤Ÿ">ğŸ¤Ÿ</span>
                        <span class="emoji" data-emoji="ğŸ‘">ğŸ‘</span>
                        <span class="emoji" data-emoji="ğŸ™">ğŸ™</span>
                        <span class="emoji" data-emoji="ğŸŠ">ğŸŠ</span>
                        <span class="emoji" data-emoji="ğŸ">ğŸ</span>
                        <span class="emoji" data-emoji="ğŸŒ¸">ğŸŒ¸</span>
                        <span class="emoji" data-emoji="ğŸŒŸ">ğŸŒŸ</span>
                        <span class="emoji" data-emoji="ğŸŒˆ">ğŸŒˆ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ç”¨æˆ·ä¿¡æ¯
        const nickname = '{{ nickname }}';
        const server = '{{ server }}';
        
        // è¿æ¥WebSocket
        const socket = io();
        
        // é¡µé¢å…ƒç´ 
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const usersList = document.getElementById('users-list');
        const usersCount = document.getElementById('users-count');
        const emojiButtons = document.querySelectorAll('.emoji');
        const emojiToggle = document.getElementById('emoji-toggle');
        const emojiPanel = document.getElementById('emoji-panel');
        
        // åˆ›å»ºéŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾éŸ³ä¹
        let audioPlayer = null;
        let currentMusicId = null;
        let isSeeking = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦æ­£åœ¨æ‹–åŠ¨è¿›åº¦æ¡
        
        // å‘é€æ¶ˆæ¯å‡½æ•°
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                const timestamp = new Date().toLocaleString('zh-CN');
                
                // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                socket.emit('send_message', {
                    nickname: nickname,
                    message: message,
                    timestamp: timestamp
                });
                
                messageInput.value = '';
            }
        }
        
        // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨å‡½æ•°
        function showNewsList(nickname, newsList) {
            const chatMessages = document.getElementById('chat-messages');
            
            // åˆ›å»ºæ¶ˆæ¯å¤´éƒ¨
            const messageHeader = document.createElement('div');
            messageHeader.classList.add('message-header', 'message-header-ai');
            messageHeader.innerHTML = `<strong>${nickname}</strong> <span class="message-time">${new Date().toLocaleString('zh-CN')}</span>`;
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');
            messageWrapper.appendChild(messageHeader);
            
            // åˆ›å»ºæ–°é—»å®¹å™¨
            const newsContainer = document.createElement('div');
            newsContainer.className = 'news-list';
            
            // æ·»åŠ æ–°é—»æ ‡é¢˜
            const newsTitle = document.createElement('div');
            newsTitle.className = 'news-title';
            newsTitle.textContent = 'ğŸ“° ä»Šæ—¥çƒ­ç‚¹æ–°é—»';
            newsContainer.appendChild(newsTitle);
            
            // æ·»åŠ æ–°é—»åˆ—è¡¨
            newsList.forEach((news, index) => {
                const newsItem = document.createElement('a');
                newsItem.href = news.url;
                newsItem.target = '_blank';
                newsItem.className = 'news-item';
                
                // æ–°é—»æ’å
                const newsRank = document.createElement('span');
                newsRank.className = 'news-rank';
                newsRank.textContent = news.index || (index + 1);
                
                // æ–°é—»å†…å®¹
                const newsContent = document.createElement('div');
                newsContent.className = 'news-content';
                
                // æ ‡é¢˜å’Œçƒ­åº¦
                const titleRow = document.createElement('div');
                titleRow.className = 'news-title-row';
                
                const title = document.createElement('span');
                title.className = 'news-item-title';
                title.textContent = news.title;
                
                const hot = document.createElement('span');
                hot.className = 'news-hot';
                hot.textContent = `ğŸ”¥${news.hot}`;
                
                titleRow.appendChild(title);
                titleRow.appendChild(hot);
                
                // æè¿°
                if (news.desc) {
                    const desc = document.createElement('div');
                    desc.className = 'news-desc';
                    desc.textContent = news.desc;
                    newsContent.appendChild(desc);
                }
                
                // å›¾ç‰‡
                if (news.img) {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'news-img-container';
                    const img = document.createElement('img');
                    img.src = news.img;
                    img.alt = news.title;
                    img.className = 'news-img';
                    imgContainer.appendChild(img);
                    newsItem.appendChild(imgContainer);
                }
                
                newsContent.appendChild(titleRow);
                newsItem.appendChild(newsRank);
                newsItem.appendChild(newsContent);
                newsContainer.appendChild(newsItem);
            });
            
            messageWrapper.appendChild(newsContainer);
            chatMessages.appendChild(messageWrapper);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
        function displayMessage(data) {
            // åˆ›å»ºæ¶ˆæ¯å¤´éƒ¨ï¼Œæ ¹æ®ç”¨æˆ·ç±»å‹è®¾ç½®ä¸åŒä½ç½®
            const messageHeader = document.createElement('div');
            messageHeader.classList.add('message-header');
            
            // ä¸ºAIæ˜µç§°æ·»åŠ ç‰¹æ®Šæ ·å¼ç±»ï¼Œæ”¾ç½®åœ¨å·¦ä¸Šè§’
                if (data.nickname === 'å·å°å†œ' || data.nickname === 'å¤©æ°”' || data.nickname === 'éŸ³ä¹åŠ©æ‰‹') {
                messageHeader.classList.add('message-header-ai');
                messageHeader.innerHTML = `<strong>${data.nickname}</strong> <span class="message-time">${data.timestamp}</span>`;
            } else {
                // æ™®é€šç”¨æˆ·æ˜µç§°ä¿æŒåœ¨å³ä¸Šè§’
                messageHeader.innerHTML = `<span class="message-time">${data.timestamp}</span> <strong>${data.nickname}</strong>`;
            }
            
            // åˆ›å»ºæ¶ˆæ¯å®¹å™¨
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹åˆ›å»ºä¸åŒçš„å†…å®¹å…ƒç´ 
            if (data.type === 'ai_chat_response') {
                // å¤„ç†æ–°é—»å°åŠ©æ‰‹çš„æ¶ˆæ¯
                if (data.nickname === 'æ–°é—»' && typeof data.content === 'object' && data.content.news) {
                    // æ˜¾ç¤ºæ–°é—»åˆ—è¡¨
                    messageWrapper.appendChild(messageHeader);
                    
                    // åˆ›å»ºæ–°é—»å®¹å™¨
                    const newsContainer = document.createElement('div');
                    newsContainer.className = 'news-list';
                    
                    // æ·»åŠ æ–°é—»æ ‡é¢˜
                    const newsTitle = document.createElement('div');
                    newsTitle.className = 'news-title';
                    newsTitle.textContent = 'ğŸ“° ä»Šæ—¥çƒ­ç‚¹æ–°é—»';
                    newsContainer.appendChild(newsTitle);
                    
                    // æ·»åŠ æ–°é—»åˆ—è¡¨
                    data.content.news.forEach((news, index) => {
                        const newsItem = document.createElement('a');
                        newsItem.href = news.url;
                        newsItem.target = '_blank';
                        newsItem.className = 'news-item';
                        
                        // æ–°é—»æ’å
                        const newsRank = document.createElement('span');
                        newsRank.className = 'news-rank';
                        newsRank.textContent = news.index || (index + 1);
                        
                        // æ–°é—»å†…å®¹
                        const newsContent = document.createElement('div');
                        newsContent.className = 'news-content';
                        
                        // æ ‡é¢˜å’Œçƒ­åº¦
                        const titleRow = document.createElement('div');
                        titleRow.className = 'news-title-row';
                        
                        const title = document.createElement('span');
                        title.className = 'news-item-title';
                        title.textContent = news.title;
                        
                        const hot = document.createElement('span');
                        hot.className = 'news-hot';
                        hot.textContent = `ğŸ”¥${news.hot}`;
                        
                        titleRow.appendChild(title);
                        titleRow.appendChild(hot);
                        
                        // æè¿°
                        if (news.desc) {
                            const desc = document.createElement('div');
                            desc.className = 'news-desc';
                            desc.textContent = news.desc;
                            newsContent.appendChild(desc);
                        }
                        
                        // å›¾ç‰‡
                        if (news.img) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'news-img-container';
                            const img = document.createElement('img');
                            img.src = news.img;
                            img.alt = news.title;
                            img.className = 'news-img';
                            imgContainer.appendChild(img);
                            newsItem.appendChild(imgContainer);
                        }
                        
                        newsContent.appendChild(titleRow);
                        newsItem.appendChild(newsRank);
                        newsItem.appendChild(newsContent);
                        newsContainer.appendChild(newsItem);
                    });
                    
                    messageWrapper.appendChild(newsContainer);
                } else {
                    // å…¶ä»–AIå›å¤æ¶ˆæ¯ - å»æ‰æ°”æ³¡ï¼Œç›´æ¥æ˜¾ç¤ºå†…å®¹
                    const aiContent = document.createElement('div');
                    aiContent.classList.add('ai-response');
                    aiContent.textContent = data.content;
                    
                    messageWrapper.appendChild(messageHeader);
                    messageWrapper.appendChild(aiContent);
                }
            } else {
                // æ™®é€šæ¶ˆæ¯å’Œç”µå½±æ¶ˆæ¯ - ä¿ç•™æ°”æ³¡
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                
                if (data.nickname === nickname) {
                    messageElement.classList.add('message-self');
                }
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                
                if (data.type === 'movie') {
                    // ç”µå½±ç±»å‹æ¶ˆæ¯ï¼Œæ˜¾ç¤ºiframe
                    messageContent.innerHTML = `
                        <div class="movie-container">
                            <p>åˆ†äº«äº†ä¸€éƒ¨ç”µå½±ï¼š${data.message}</p>
                            <iframe src="${data.content}" class="movie-iframe" width="400" height="400" allowfullscreen></iframe>
                        </div>
                    `;
                } else if (data.type === 'weather') {
                    // å¤©æ°”ç±»å‹æ¶ˆæ¯ï¼Œç‰¹æ®Šæ ¼å¼åŒ–æ˜¾ç¤º
                    messageContent.innerHTML = `
                        <div class="weather-container">
                            <p class="weather-title">æŸ¥è¯¢äº†å¤©æ°”ä¿¡æ¯</p>
                            <pre class="weather-info">${data.content}</pre>
                        </div>
                    `;
                } else if (data.type === 'music' && typeof data.content === 'object') {
                    // éŸ³ä¹ç±»å‹æ¶ˆæ¯ï¼Œæ˜¾ç¤ºéŸ³ä¹å¡ç‰‡
                    // åˆ›å»ºéŸ³ä¹å¡ç‰‡ï¼ŒåŒ…å«IDä»¥ä¾¿è·Ÿè¸ª
                    const musicId = data.content.id || Date.now();
                    messageContent.innerHTML = `
                        <div class="music-container" data-music-id="${musicId}" data-music-url="${data.content.url || 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'}">
                            <div class="music-info">
                                <img class="music-image" src="${data.content.image || 'https://via.placeholder.com/150'}" alt="ä¸“è¾‘å°é¢">
                                <div class="music-details">
                                    <h4 class="music-title">${data.content.name}</h4>
                                    <p class="music-artist">${data.content.artist}</p>
                                    ${data.content.status ? `<span class="music-status">çŠ¶æ€: ${getReadableStatus(data.content.status)}</span>` : ''}
                                </div>
                            </div>
                            <div class="music-controls">
                                <button class="music-control-btn" data-action="play" title="æ’­æ”¾">â–¶ï¸</button>
                                <button class="music-control-btn" data-action="pause" title="æš‚åœ">â¸ï¸</button>
                                <button class="music-control-btn" data-action="stop" title="åœæ­¢">â¹ï¸</button>
                            </div>
                            <div class="music-progress-container">
                                <div class="music-progress-bar" style="width: ${data.content.progress || 0}%"></div>
                            </div>
                        </div>
                    `;
                } else {
                    // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                    messageContent.textContent = data.message;
                }
                
                messageElement.appendChild(messageContent);
                messageWrapper.appendChild(messageHeader);
                messageWrapper.appendChild(messageElement);
            }
            
            chatMessages.appendChild(messageWrapper);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function updateUsersList(users) {
            usersList.innerHTML = '';
            usersCount.textContent = users.length;
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.classList.add('user-item');
                if (user === nickname) {
                    userElement.classList.add('user-self');
                    userElement.innerHTML = `<span class="user-dot"></span> ${user} (æˆ‘)`;
                } else {
                    userElement.innerHTML = `<span class="user-dot"></span> ${user}`;
                }
                usersList.appendChild(userElement);
            });
        }
        
        // äº‹ä»¶ç›‘å¬ (å°†åœ¨é¡µé¢åº•éƒ¨é‡å†™ä»¥æ·»åŠ éŸ³ä¹çŠ¶æ€è¯·æ±‚)
        
        // Emojié¢æ¿åˆ‡æ¢åŠŸèƒ½
        emojiToggle.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘æ–‡æ¡£ç‚¹å‡»äº‹ä»¶
            emojiPanel.classList.toggle('active');
        });
        
        // ç‚¹å‡»æ–‡æ¡£å…¶ä»–åœ°æ–¹å…³é—­emojié¢æ¿
        document.addEventListener('click', () => {
            if (emojiPanel.classList.contains('active')) {
                emojiPanel.classList.remove('active');
            }
        });
        
        // ç‚¹å‡»emojié¢æ¿å†…éƒ¨ä¸å…³é—­é¢æ¿
        emojiPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Emojiç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–æ€§èƒ½ï¼‰
        emojiPanel.addEventListener('click', (e) => {
            if (e.target.classList.contains('emoji')) {
                const emoji = e.target.getAttribute('data-emoji');
                messageInput.value += emoji;
                messageInput.focus();
            }
        });
        
        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–ç”¨æˆ·åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·åˆ—è¡¨æ›´æ–°');
            
            // ä¾§è¾¹æ åˆ‡æ¢
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const usersSidebar = document.querySelector('.users-sidebar');
            
            if (sidebarToggle && usersSidebar) {
                sidebarToggle.addEventListener('click', function() {
                    usersSidebar.classList.toggle('active');
                });
            }
        });
        
        // æ¥æ”¶æ–°æ¶ˆæ¯
        socket.on('new_message', (data) => {
            displayMessage(data);
            
            // å¤„ç†å¤©æ°”ç±»å‹ï¼Œæ›´æ”¹èŠå¤©æ¡†èƒŒæ™¯é¢œè‰²
            if (data.nickname === 'å¤©æ°”' && data.weather_type) {
                const chatMessages = document.getElementById('chat-messages');
                // ç§»é™¤æ‰€æœ‰å¤©æ°”ç›¸å…³çš„ç±»
                chatMessages.classList.remove('weather-sunny', 'weather-cloudy', 'weather-rainy');
                // æ·»åŠ å½“å‰å¤©æ°”ç±»å‹çš„ç±»
                chatMessages.classList.add(`weather-${data.weather_type}`);
                
                // 30ç§’åæ¢å¤é»˜è®¤èƒŒæ™¯
                setTimeout(() => {
                    chatMessages.classList.remove('weather-sunny', 'weather-cloudy', 'weather-rainy');
                }, 30000);
            }
        });
        
        // ç”¨æˆ·åŠ å…¥
        socket.on('user_joined', (data) => {
            updateUsersList(data.users);
            
            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
            const systemMessage = document.createElement('div');
            systemMessage.classList.add('system-message');
            systemMessage.textContent = `${data.nickname} åŠ å…¥äº†èŠå¤©å®¤`;
            chatMessages.appendChild(systemMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        
        // ç”¨æˆ·ç¦»å¼€
        socket.on('user_left', (data) => {
            updateUsersList(data.users);
            
            // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
            const systemMessage = document.createElement('div');
            systemMessage.classList.add('system-message');
            systemMessage.textContent = `${data.nickname} ç¦»å¼€äº†èŠå¤©å®¤`;
            chatMessages.appendChild(systemMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        
        // ç›‘å¬ç”¨æˆ·åˆ—è¡¨æ›´æ–°äº‹ä»¶ï¼ˆä¸“é—¨é’ˆå¯¹æ–°åŠ å…¥çš„ç”¨æˆ·ï¼‰
        socket.on('update_users', (data) => {
            console.log('æ¥æ”¶åˆ°ç”¨æˆ·åˆ—è¡¨æ›´æ–°:', data.users);
            updateUsersList(data.users);
        });
        
        // ç›‘å¬éŸ³ä¹æ›´æ–°äº‹ä»¶
        socket.on('music_updated', (data) => {
            console.log('æ¥æ”¶åˆ°éŸ³ä¹æ›´æ–°:', data);
            
            // æ›´æ–°å½“å‰éŸ³ä¹ID
            currentMusicId = data.id || Date.now();
            
            // ç›´æ¥æ˜¾ç¤ºéŸ³ä¹åŠ©æ‰‹æ¶ˆæ¯å’ŒéŸ³ä¹å¡ç‰‡
            displayMessage({
                nickname: 'éŸ³ä¹åŠ©æ‰‹',
                message: data.name ? `æ­£åœ¨æ’­æ”¾éŸ³ä¹: ${data.name} - ${data.artist}` : 'æ­£åœ¨æ’­æ”¾éšæœºéŸ³ä¹',
                type: 'music',
                content: data,
                timestamp: new Date().toLocaleString('zh-CN')
            });
            
            // æ›´æ–°ç•Œé¢ä¸Šç°æœ‰çš„éŸ³ä¹å¡ç‰‡ä¿¡æ¯
            updateMusicCardInfo(data);
            
            // æ¸…ç†ä¹‹å‰çš„éŸ³é¢‘æ’­æ”¾å™¨
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.removeEventListener('timeupdate', updateMusicProgress);
                audioPlayer.removeEventListener('ended', handleMusicEnded);
                audioPlayer = null;
            }
            
            // åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ ï¼ˆå¦‚æœæœ‰æœ‰æ•ˆçš„URLï¼‰
            // ä½¿ç”¨é»˜è®¤URLæˆ–æä¾›çš„URL
            const audioUrl = data.url || 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
            
            try {
                console.log('åˆ›å»ºéŸ³é¢‘å…ƒç´ ï¼ŒURL:', audioUrl);
                audioPlayer = new Audio(audioUrl);
                
                // ç¡®ä¿éŸ³é‡è®¾ç½®ä¸ºæœ€å¤§
                audioPlayer.volume = 1.0;
                console.log('éŸ³é¢‘å…ƒç´ å·²åˆ›å»ºï¼ŒéŸ³é‡è®¾ç½®ä¸º:', audioPlayer.volume);
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                audioPlayer.addEventListener('timeupdate', updateMusicProgress);
                audioPlayer.addEventListener('ended', handleMusicEnded);
                
                // æ·»åŠ åŠ è½½å®Œæˆäº‹ä»¶
                audioPlayer.addEventListener('loadedmetadata', () => {
                    console.log('éŸ³é¢‘å…ƒæ•°æ®å·²åŠ è½½:', { 
                        duration: audioPlayer.duration,
                        readyState: audioPlayer.readyState
                    });
                });
                
                // æ·»åŠ canplayäº‹ä»¶
                audioPlayer.addEventListener('canplay', () => {
                    console.log('éŸ³é¢‘å¯ä»¥å¼€å§‹æ’­æ”¾');
                });
                
                // å¢å¼ºçš„é”™è¯¯äº‹ä»¶ç›‘å¬
                audioPlayer.addEventListener('error', function(e) {
                    const errorCode = e.target.error ? e.target.error.code : 'Unknown';
                    const errorTypes = ['', 'ä¸­æ­¢', 'ç½‘ç»œé”™è¯¯', 'è§£ç é”™è¯¯', 'æ ¼å¼ä¸æ”¯æŒ'];
                    const errorText = errorTypes[errorCode] || 'æœªçŸ¥é”™è¯¯';
                    
                    console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e, 'é”™è¯¯ä»£ç :', errorCode, '(', errorText, ')');
                    
                    // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯æç¤ºç»™ç”¨æˆ·
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'music-error-message';
                    errorMessage.textContent = `éŸ³é¢‘åŠ è½½å¤±è´¥(${errorText})ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®é‡è¯•`;
                    errorMessage.style.color = 'red';
                    errorMessage.style.marginTop = '5px';
                    errorMessage.style.fontSize = '12px';
                    
                    // å°†é”™è¯¯æ¶ˆæ¯æ·»åŠ åˆ°æœ€æ–°çš„éŸ³ä¹å¡ç‰‡
                    const musicContainers = document.querySelectorAll('.music-container');
                    if (musicContainers.length > 0) {
                        const latestContainer = musicContainers[musicContainers.length - 1];
                        // ç§»é™¤å·²å­˜åœ¨çš„é”™è¯¯æ¶ˆæ¯
                        const existingError = latestContainer.querySelector('.music-error-message');
                        if (existingError) existingError.remove();
                        latestContainer.appendChild(errorMessage);
                    }
                });
                
                // å°è¯•é¢„åŠ è½½
                audioPlayer.load();
                
                // å¦‚æœéŸ³ä¹çŠ¶æ€æ˜¯playingï¼Œåˆ™å°è¯•æ’­æ”¾
                if (data.status === 'playing') {
                    audioPlayer.play().catch(error => {
                        console.error('è‡ªåŠ¨æ’­æ”¾éŸ³ä¹å¤±è´¥ï¼ˆå¯èƒ½è¢«æµè§ˆå™¨ç­–ç•¥é˜»æ­¢ï¼‰:', error);
                        console.log('æç¤ºï¼šè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ‰‹åŠ¨æ’­æ”¾éŸ³ä¹');
                        // ä¸è‡ªåŠ¨è®¾ç½®ä¸ºæš‚åœï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾
                    });
                }
            } catch (error) {
                console.error('åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert('éŸ³é¢‘æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });
        
        // éŸ³ä¹æ’­æ”¾ç»“æŸå¤„ç†å‡½æ•°
        function handleMusicEnded() {
            console.log('éŸ³ä¹æ’­æ”¾ç»“æŸ');
            socket.emit('music_control', { action: 'stop' });
        }
        
        // æ›´æ–°éŸ³ä¹å¡ç‰‡ä¿¡æ¯çš„å‡½æ•°
        function updateMusicCardInfo(data) {
            const musicContainers = document.querySelectorAll('.music-container');
            
            // å¦‚æœæœ‰ç°æœ‰éŸ³ä¹å¡ç‰‡ï¼Œæ›´æ–°å®ƒä»¬
            if (musicContainers.length > 0) {
                musicContainers.forEach(container => {
                    // æ›´æ–°éŸ³ä¹ä¿¡æ¯
                    const titleElement = container.querySelector('.music-title');
                    const artistElement = container.querySelector('.music-artist');
                    const statusElement = container.querySelector('.music-status');
                    const imageElement = container.querySelector('.music-image');
                    
                    if (titleElement) titleElement.textContent = data.name || 'æœªçŸ¥æ­Œæ›²';
                    if (artistElement) artistElement.textContent = data.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
                    if (statusElement) statusElement.textContent = `çŠ¶æ€: ${getReadableStatus(data.status)}`;
                    if (imageElement) imageElement.src = data.image || 'https://via.placeholder.com/150';
                    
                    // æ›´æ–°URLå±æ€§ï¼Œæ·»åŠ é»˜è®¤æµ‹è¯•éŸ³é¢‘URL
                    container.dataset.musicUrl = data.url || 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
                });
            } else {
                // ä¸å†åœ¨è¿™é‡Œåˆ›å»ºæ–°çš„éŸ³ä¹æ¶ˆæ¯æ˜¾ç¤ºï¼Œç»Ÿä¸€ç”±music_updatedäº‹ä»¶å¤„ç†å™¨å¤„ç†
            }
        }
        
        // ç›‘å¬éŸ³ä¹çŠ¶æ€æ›´æ–°äº‹ä»¶
        socket.on('music_status_updated', (data) => {
            console.log('æ¥æ”¶åˆ°éŸ³ä¹çŠ¶æ€æ›´æ–°:', data);
            
            // æ›´æ–°å½“å‰éŸ³ä¹IDï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (data.id) {
                currentMusicId = data.id;
            }
            
            // æ›´æ–°è¿›åº¦æ¡ - åªæœ‰åœ¨éæ‹–åŠ¨çŠ¶æ€æ‰æ›´æ–°
            if (data.progress !== undefined && !isSeeking) {
                const progressBars = document.querySelectorAll('.music-progress-bar');
                progressBars.forEach(bar => {
                    bar.style.width = `${data.progress}%`;
                });
            }
            
            // æ§åˆ¶éŸ³ä¹æ’­æ”¾çŠ¶æ€
            if (audioPlayer) {
                try {
                    if (data.status === 'playing' && audioPlayer.paused) {
                        audioPlayer.play().catch(error => {
                            console.error('æ’­æ”¾éŸ³ä¹å¤±è´¥:', error);
                            // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºæµè§ˆå™¨ç­–ç•¥ï¼Œå°è¯•ç”¨æˆ·äº¤äº’åå†æ’­æ”¾
                            const playBtn = document.querySelector('.music-control-btn[data-action="play"]');
                            if (playBtn) {
                                playBtn.classList.add('play-error'); // å¯ä»¥æ·»åŠ æ ·å¼æç¤ºç”¨æˆ·ç‚¹å‡»æ’­æ”¾
                            }
                        });
                    } else if (data.status === 'paused' && !audioPlayer.paused) {
                        audioPlayer.pause();
                    } else if (data.status === 'stopped') {
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        // æ¸…é™¤æ‰€æœ‰è¿›åº¦æ¡
                        const progressBars = document.querySelectorAll('.music-progress-bar');
                        progressBars.forEach(bar => {
                            bar.style.width = '0%';
                        });
                    }
                    
                    // å¦‚æœæœ‰è¿›åº¦ä¿¡æ¯ä¸”ä¸æ˜¯ç”¨æˆ·æ­£åœ¨æ‹–åŠ¨ï¼Œæ›´æ–°éŸ³é¢‘è¿›åº¦
                    if (data.progress !== undefined && !isSeeking && audioPlayer && audioPlayer.duration) {
                        const newTime = (data.progress / 100) * audioPlayer.duration;
                        // åªæœ‰å½“å·®å¼‚å¤§äº1ç§’æ—¶æ‰æ›´æ–°ï¼Œé¿å…é¢‘ç¹æ›´æ–°
                        if (Math.abs(audioPlayer.currentTime - newTime) > 1) {
                            audioPlayer.currentTime = newTime;
                        }
                    }
                    
                    // æ›´æ–°ç•Œé¢ä¸Šçš„æ’­æ”¾çŠ¶æ€æ˜¾ç¤º
                    const statusElements = document.querySelectorAll('.music-status');
                    statusElements.forEach(el => {
                        el.textContent = `çŠ¶æ€: ${getReadableStatus(data.status)}`;
                    });
                } catch (error) {
                    console.error('æ›´æ–°éŸ³é¢‘çŠ¶æ€å¤±è´¥:', error);
                }
            }
        });
        
        // æ›´æ–°éŸ³ä¹è¿›åº¦å‡½æ•°
        function updateMusicProgress() {
            if (audioPlayer && audioPlayer.duration > 0 && !isSeeking) {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                socket.emit('music_control', {
                    action: 'progress',
                    progress: progress
                });
            }
        }
        
        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendBtn.addEventListener('click', sendMessage);
        
        // å›è½¦é”®å‘é€æ¶ˆæ¯
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        logoutBtn.addEventListener('click', () => {
            socket.disconnect();
            window.location.href = '/';
        });
        
        // Emojiç‚¹å‡»äº‹ä»¶
        emojiButtons.forEach(button => {
            button.addEventListener('click', () => {
                const emoji = button.getAttribute('data-emoji');
                messageInput.value += emoji;
                messageInput.focus();
            });
        });
        
        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });
        
        // ä¸ºéŸ³ä¹æ§åˆ¶æŒ‰é’®æ·»åŠ äº‹ä»¶å§”æ‰˜ç›‘å¬
        document.addEventListener('click', (e) => {
            // å¤„ç†éŸ³ä¹æ§åˆ¶æŒ‰é’®ç‚¹å‡»
            if (e.target.classList.contains('music-control-btn')) {
                const action = e.target.getAttribute('data-action');
                
                // æŸ¥æ‰¾å¯¹åº”çš„éŸ³ä¹å¡ç‰‡å’ŒéŸ³ä¹URL
                const musicCard = e.target.closest('.music-container');
                const musicUrl = musicCard ? musicCard.getAttribute('data-music-url') : null;
                const musicId = musicCard ? musicCard.getAttribute('data-music-id') : null;
                
                // ç«‹å³åœ¨æœ¬åœ°å¤„ç†æ’­æ”¾æ§åˆ¶ï¼Œæä¾›å³æ—¶åé¦ˆ
                try {
                    if (action === 'play') {
                        if (musicUrl && musicId) {
                            // å¦‚æœæ˜¯æ–°éŸ³ä¹ï¼ˆIDå˜åŒ–æˆ–URLå˜åŒ–ï¼‰ï¼Œåˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ 
                                // æ·»åŠ å…¨å±€å˜é‡è®°å½•å½“å‰æ’­æ”¾çš„URL
                                if (!window.currentMusicUrl) window.currentMusicUrl = '';
                                
                                if (!audioPlayer || currentMusicId !== musicId || window.currentMusicUrl !== musicUrl) {
                                // æ¸…ç†æ—§çš„éŸ³é¢‘å…ƒç´ 
                                if (audioPlayer) {
                                    audioPlayer.pause();
                                    audioPlayer = null;
                                }
                                
                                // åˆ›å»ºæ–°çš„éŸ³é¢‘å…ƒç´ 
                                audioPlayer = new Audio(musicUrl);
                                // ç«‹å³è®¾ç½®éŸ³é‡ä¸ºæœ€å¤§ï¼Œç¡®ä¿æœ‰å£°éŸ³
                                audioPlayer.volume = 1.0;
                                console.log('åˆ›å»ºæ–°éŸ³é¢‘å…ƒç´ å¹¶è®¾ç½®éŸ³é‡ä¸º:', audioPlayer.volume);
                                currentMusicId = musicId;
                                // æ›´æ–°å½“å‰æ’­æ”¾çš„URL
                                window.currentMusicUrl = musicUrl;
                                
                                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                                audioPlayer.addEventListener('timeupdate', updateMusicProgress);
                                audioPlayer.addEventListener('ended', () => {
                                    // éŸ³ä¹æ’­æ”¾ç»“æŸæ—¶æ›´æ–°çŠ¶æ€
                                    socket.emit('music_control', { action: 'stop' });
                                });
                                audioPlayer.addEventListener('error', (err) => {
                                    console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', err);
                                    e.target.classList.add('play-error');
                                });
                            }
                            
                            // æ’­æ”¾éŸ³é¢‘ - æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—
                                console.log('ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼Œå‡†å¤‡æ’­æ”¾:', { musicUrl, musicId });
                                console.log('éŸ³é¢‘å…ƒç´ çŠ¶æ€æ£€æŸ¥:', { 
                                    readyState: audioPlayer.readyState,
                                    networkState: audioPlayer.networkState,
                                    paused: audioPlayer.paused
                                });
                                
                                // ç«‹å³è®¾ç½®éŸ³é‡ä¸ºæœ€å¤§å¹¶è®°å½•
                                audioPlayer.volume = 1.0;
                                console.log('å·²è®¾ç½®éŸ³é¢‘éŸ³é‡ä¸º:', audioPlayer.volume);
                                
                                // æ·»åŠ canplaythroughäº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿éŸ³é¢‘å¯ä»¥æµç•…æ’­æ”¾
                                const handleCanPlayThrough = () => {
                                    console.log('éŸ³é¢‘å·²åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¥½æµç•…æ’­æ”¾');
                                    audioPlayer.removeEventListener('canplaythrough', handleCanPlayThrough);
                                };
                                audioPlayer.addEventListener('canplaythrough', handleCanPlayThrough);
                                
                                // å°è¯•æ’­æ”¾
                                audioPlayer.play().then(() => {
                                    console.log('éŸ³é¢‘æ’­æ”¾æˆåŠŸï¼æ­£åœ¨æ’­æ”¾:', musicUrl);
                                    console.log('æ’­æ”¾çŠ¶æ€ç¡®è®¤:', { 
                                        currentTime: audioPlayer.currentTime,
                                        duration: audioPlayer.duration,
                                        paused: audioPlayer.paused
                                    });
                                    e.target.classList.remove('play-error');
                                    
                                    // æ›´æ–°ç•Œé¢ä¸Šçš„æ’­æ”¾çŠ¶æ€
                                    const statusElements = document.querySelectorAll('.music-status');
                                    statusElements.forEach(el => {
                                        el.textContent = 'çŠ¶æ€: æ’­æ”¾ä¸­';
                                    });
                                }).catch(err => {
                                    console.error('æ’­æ”¾å¤±è´¥:', err.message || err);
                                    console.error('é”™è¯¯è¯¦æƒ…:', { 
                                        errorCode: audioPlayer.error ? audioPlayer.error.code : 'Unknown',
                                        src: audioPlayer.src,
                                        networkState: audioPlayer.networkState
                                    });
                                    e.target.classList.add('play-error');
                                    
                                    // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯æç¤º
                                    let errorMessage = 'æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚';
                                    if (audioPlayer.error) {
                                        switch(audioPlayer.error.code) {
                                            case 1: errorMessage += ' (éŸ³é¢‘åŠ è½½è¢«ä¸­æ­¢)'; break;
                                            case 2: errorMessage += ' (ç½‘ç»œè¿æ¥é”™è¯¯)'; break;
                                            case 3: errorMessage += ' (è§£ç é”™è¯¯)'; break;
                                            case 4: errorMessage += ' (éŸ³é¢‘æ ¼å¼ä¸æ”¯æŒ)'; break;
                                        }
                                    }
                                    alert(errorMessage);
                                });
                        }
                    } else if (action === 'pause' && audioPlayer) {
                        audioPlayer.pause();
                    } else if (action === 'stop' && audioPlayer) {
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                    }
                } catch (error) {
                    console.error('éŸ³é¢‘æ§åˆ¶é”™è¯¯:', error);
                }
                
                // å‘é€æ§åˆ¶äº‹ä»¶åˆ°æœåŠ¡å™¨ï¼Œç¡®ä¿æ‰€æœ‰ç”¨æˆ·åŒæ­¥
                socket.emit('music_control', { action: action });
                
                // å¯¹äºæ’­æ”¾æŒ‰é’®ï¼Œå¦‚æœæœ‰é”™è¯¯æç¤ºï¼Œæ¸…é™¤å®ƒ
                if (action === 'play') {
                    e.target.classList.remove('play-error');
                }
            }
            
            // å¤„ç†è¿›åº¦æ¡ç‚¹å‡»ï¼Œå…è®¸ç”¨æˆ·ç‚¹å‡»è¿›åº¦æ¡æ”¹å˜æ’­æ”¾ä½ç½®
            else if (e.target.classList.contains('music-progress-container')) {
                if (!audioPlayer) return;
                
                try {
                    const container = e.target;
                    const rect = container.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const percent = (clickX / rect.width) * 100;
                    
                    // æ›´æ–°éŸ³é¢‘è¿›åº¦
                    audioPlayer.currentTime = (percent / 100) * audioPlayer.duration;
                    
                    // é€šçŸ¥æœåŠ¡å™¨è¿›åº¦å˜åŒ–
                    socket.emit('music_control', {
                        action: 'progress',
                        progress: percent
                    });
                } catch (error) {
                    console.error('æ›´æ–°éŸ³ä¹è¿›åº¦å¤±è´¥:', error);
                }
            }
        });
        
        // ä¸ºè¿›åº¦æ¡æ·»åŠ æ‹–åŠ¨äº‹ä»¶ç›‘å¬ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('music-progress-bar')) {
                isSeeking = true;
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isSeeking) {
                isSeeking = false;
                // æ‹–åŠ¨ç»“æŸåï¼Œæ›´æ–°æœåŠ¡å™¨
                if (audioPlayer && audioPlayer.duration > 0) {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    socket.emit('music_control', {
                        action: 'progress',
                        progress: progress
                    });
                }
            }
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isSeeking && e.target.closest('.music-progress-container')) {
                try {
                    const container = e.target.closest('.music-progress-container');
                    const rect = container.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const percent = Math.max(0, Math.min(100, (mouseX / rect.width) * 100));
                    
                    // æ›´æ–°æ‰€æœ‰è¿›åº¦æ¡æ˜¾ç¤º
                    const progressBars = document.querySelectorAll('.music-progress-bar');
                    progressBars.forEach(bar => {
                        bar.style.width = `${percent}%`;
                    });
                    
                    // æ›´æ–°éŸ³é¢‘è¿›åº¦
                    if (audioPlayer) {
                        audioPlayer.currentTime = (percent / 100) * audioPlayer.duration;
                    }
                } catch (error) {
                    console.error('æ‹–åŠ¨è¿›åº¦æ¡å¤±è´¥:', error);
                }
            }
        });
        
        // è·å–å¯è¯»çš„éŸ³ä¹çŠ¶æ€æ–‡æœ¬
        function getReadableStatus(status) {
            const statusMap = {
                'playing': 'æ’­æ”¾ä¸­',
                'paused': 'å·²æš‚åœ',
                'stopped': 'å·²åœæ­¢'
            };
            return statusMap[status] || status;
        }
        
        // è¿æ¥æˆåŠŸåè¯·æ±‚å½“å‰éŸ³ä¹çŠ¶æ€
        socket.on('connect', () => {
            console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            // åŠ å…¥èŠå¤©å®¤
            socket.emit('join', { nickname: nickname, username: '{{ username }}' });
            // è¯·æ±‚å½“å‰éŸ³ä¹çŠ¶æ€
            setTimeout(() => {
                socket.emit('get_current_music');
            }, 500); // å»¶è¿Ÿä¸€ç‚¹å‘é€è¯·æ±‚ï¼Œç¡®ä¿è¿æ¥å®Œå…¨å»ºç«‹
        });
        
        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå¦‚æœç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µï¼Œæš‚åœéŸ³ä¹
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && audioPlayer && !audioPlayer.paused) {
                // å­˜å‚¨æš‚åœå‰çš„çŠ¶æ€ï¼Œä»¥ä¾¿é¡µé¢é‡æ–°å¯è§æ—¶æ¢å¤
                sessionStorage.setItem('musicWasPlaying', 'true');
                socket.emit('music_control', { action: 'pause' });
            } else if (!document.hidden && sessionStorage.getItem('musicWasPlaying') === 'true') {
                // é¡µé¢é‡æ–°å¯è§ï¼Œä¸è‡ªåŠ¨æ¢å¤æ’­æ”¾ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
                sessionStorage.removeItem('musicWasPlaying');
            }
        });
    </script>
</body>
</html>